// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String      @id @default(cuid())
  phone                 String      @unique
  email                 String?     @unique
  passwordHash          String
  nickname              String?
  avatar                String?
  role                  UserRole    @default(DEVELOPER)
  status                UserStatus  @default(ACTIVE)
  emailVerified         DateTime?
  phoneVerified         DateTime?
  realNameVerified      DateTime?
  realName              String?
  idCardFront           String?
  idCardBack            String?
  idCardVerifyStatus    VerifyStatus @default(PENDING)
  companyName           String?     // For employer
  companyLicense        String?
  companyVerifyStatus   VerifyStatus @default(PENDING)
  selfIntroduction      String?
  skills                String?     // JSON array
  yearsOfExperience     Int?
  portfolioUrl          String?
  bankAccount           String?
  bankName              String?
  lastLoginAt           DateTime?
  lastLoginIp           String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  deletedAt             DateTime?

  // Relations
  employerOrders        Order[]     @relation("EmployerOrders")
  developerOrders       Order[]     @relation("DeveloperOrders")
  wallet                Wallet?
  transactions          Transaction[]
  audits                Audit[]
  uploads               FileUpload[]
  notifications         Notification[]
  withdrawalRequests    WithdrawalRequest[]
  auditorAudits         Audit[]     @relation("AuditorAudits")

  @@index([phone])
  @@index([status])
  @@index([role])
  @@index([createdAt])
}

enum UserRole {
  EMPLOYER    // 雇主
  DEVELOPER   // 开发者
  AUDITOR     // 审核员
  ADMIN       // 超级管理员
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
  DELETED
}

enum VerifyStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Order {
  id                    String        @id @default(cuid())
  title                 String
  description           String        @db.LongText
  budget                Decimal       @db.Decimal(12, 2)
  employerId            String
  developerId           String?
  auditorId             String?
  status                OrderStatus   @default(OPEN)
  deliveryDays          Int
  dueDate               DateTime?
  completedAt           DateTime?
  reviewedAt            DateTime?
  category              String?
  tags                  String?       // JSON array
  attachments           String?       // JSON array of file URLs
  developerFeedback     String?
  employerFeedback      String?
  developerRating       Int?          // 1-5
  employerRating        Int?          // 1-5
  refundReason          String?
  refundAmount          Decimal?      @db.Decimal(12, 2)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  canceledAt            DateTime?

  // Relations
  employer              User          @relation("EmployerOrders", fields: [employerId], references: [id], onDelete: Cascade)
  developer             User?         @relation("DeveloperOrders", fields: [developerId], references: [id], onDelete: SetNull)
  transactions          Transaction[]
  audits                Audit[]
  escrowTransaction     Transaction?

  @@index([employerId])
  @@index([developerId])
  @@index([status])
  @@index([createdAt])
}

enum OrderStatus {
  OPEN              // 开放中，等待接单
  IN_PROGRESS       // 进行中
  SUBMITTED         // 已提交交付
  IN_REVIEW         // 审核中
  COMPLETED         // 已完成
  CANCELLED         // 已取消
  REFUNDING         // 退款中
  REFUNDED          // 已退款
}

model Wallet {
  // 钱包ID
  id                String    @id @default(cuid())
  // 关联用户ID
  userId            String    @unique
  // 可用余额（街币）- 用户可直接使用的街币
  balance           Decimal   @default(0) @db.Decimal(12, 2)
  // 冻结余额（街币）- 发布订单时锁定的街币，完成后释放给开发者
  frozenBalance     Decimal   @default(0) @db.Decimal(12, 2)
  // 累计充值（街币）- 历史累计充值金额
  totalDeposit      Decimal   @default(0) @db.Decimal(12, 2)
  // 累计提现（街币）- 历史累计提现金额
  totalWithdraw     Decimal   @default(0) @db.Decimal(12, 2)
  // 货币单位（目前固定为CNY，即街币兑换人民币比例）
  // 【手动配置】修改 CURRENCY_RATE 环境变量来调整 1 街币 = ? 人民币
  currency          String    @default("CNY")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // 关系：钱包与用户一对一
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id                String          @id @default(cuid())
  walletId          String
  userId            String
  orderId           String?
  type              TransactionType
  amount            Decimal         @db.Decimal(12, 2)
  balance           Decimal         @db.Decimal(12, 2)  // Balance after transaction
  status            TransactionStatus @default(PENDING)
  description       String?
  externalRef       String?         // Reference from payment provider
  alipayTradeNo     String?
  paymentMethod     String?         // alipay, bank_transfer
  relatedTransactionId String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  completedAt       DateTime?

  // Relations
  wallet            Wallet          @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  order             Order?          @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([walletId])
  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@unique([externalRef])
}

enum TransactionType {
  DEPOSIT           // 充值：用户充值人民币 → 街币
  WITHDRAW          // 提现：街币 → 人民币（提现到银行卡）
  ESCROW            // 托管：发布订单时冻结街币
  RELEASE           // 释放：订单完成时将冻结的街币转移给开发者
  REFUND            // 退款：订单取消时退还街币给雇主
  PENALTY           // 罚款：违规扣除街币
  BONUS             // 奖励：平台奖励街币
}

enum TransactionStatus {
  PENDING           // 待处理
  PROCESSING        // 处理中
  SUCCESS           // 成功
  FAILED            // 失败
  CANCELLED         // 取消
  REFUNDING         // 退款中
}

model WithdrawalRequest {
  id                String              @id @default(cuid())
  userId            String
  amount            Decimal             @db.Decimal(12, 2)
  status            WithdrawalStatus    @default(PENDING)
  bankAccount       String
  bankName          String
  accountHolder     String
  rejectionReason   String?
  reviewedAt        DateTime?
  reviewedBy        String?
  completedAt       DateTime?
  transactionId     String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum WithdrawalStatus {
  PENDING           // 待审核
  APPROVED          // 已批准
  PROCESSING        // 处理中
  SUCCESS           // 成功
  FAILED            // 失败
  REJECTED          // 被拒绝
}

model Audit {
  id                String        @id @default(cuid())
  orderId           String
  auditorId         String?
  result            AuditResult
  notes             String?
  attachments       String?       // JSON array
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  auditor           User?         @relation("AuditorAudits", fields: [auditorId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([auditorId])
  @@index([createdAt])
}

enum AuditResult {
  PASSED            // 审核通过
  REJECTED          // 审核拒绝
  PENDING           // 待审核
}

model FileUpload {
  id                String    @id @default(cuid())
  userId            String
  filename          String
  originalName      String
  mimeType          String
  size              Int
  storageProvider   String    // cos, oss, local
  storagePath       String
  url               String
  checksumMd5       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id                String    @id @default(cuid())
  userId            String
  type              NotificationType
  title             String
  content           String
  relatedOrderId    String?
  isRead            Boolean   @default(false)
  readAt            DateTime?
  createdAt         DateTime  @default(now())

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  ORDER_ACCEPTED      // 订单被接受
  ORDER_SUBMITTED     // 订单已提交
  ORDER_COMPLETED     // 订单完成
  PAYMENT_SUCCESS     // 支付成功
  WITHDRAWAL_SUCCESS  // 提现成功
  WITHDRAWAL_FAILED   // 提现失败
  SYSTEM_NOTICE       // 系统通知
}

// Audit log for admin
model AuditLog {
  id                String    @id @default(cuid())
  adminId           String
  action            String
  tableName         String?
  recordId          String?
  changes           String?   // JSON
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime  @default(now())

  @@index([adminId])
  @@index([createdAt])
  @@index([action])
}
