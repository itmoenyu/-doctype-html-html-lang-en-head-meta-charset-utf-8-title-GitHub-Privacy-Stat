# 街币系统文档

## 概述

**街币（JIEZBI）**是本平台的虚拟货币系统，用于以下场景：

- 🎯 **雇主支付**：发布订单时支付街币作为报酬
- 💰 **开发者收入**：完成订单获得街币报酬
- 🏦 **充值提现**：通过支付宝充值人民币为街币，或提现街币为人民币
- 📊 **平台收入**：从订单完成时的街币转账中抽佣

---

## 关键概念

### 1. 可用余额 vs 冻结余额

| 概念 | 说明 | 用途 |
|------|------|------|
| **可用余额** | 用户可自由使用的街币 | 发布新订单、充值、提现等 |
| **冻结余额** | 已发布订单中锁定的街币 | 订单完成后支付给开发者，或取消后退还 |

**示例**：
- 雇主账户：可用 100 街币，冻结 50 街币
  - 可以继续发布最高 100 街币的订单
  - 不能提现超过 100 街币
  - 总资产 = 100 + 50 = 150 街币

### 2. 汇率转换

街币与人民币通过 **汇率** 进行转换。

**【环境变量】`CURRENCY_RATE`**

| 配置值 | 含义 | 示例 |
|--------|------|------|
| 1.0 | 1 街币 = 1 元 | 充值 100 元 = 获得 100 街币 |
| 0.5 | 1 街币 = 0.5 元 | 充值 100 元 = 获得 200 街币 |
| 2.0 | 1 街币 = 2 元 | 充值 100 元 = 获得 50 街币 |

**修改方法**：编辑 `.env` 文件，修改 `CURRENCY_RATE` 的值

### 3. 平台抽佣

当开发者通过完成订单获得报酬时，平台会抽取一定比例。

**【环境变量】`COMMISSION_RATE`**

| 配置值 | 含义 |
|--------|------|
| 5 | 平台抽 5% |
| 10 | 平台抽 10% |
| 0 | 平台不抽佣 |

**计算示例**：
```
订单金额：100 街币
平台抽佣比例：5%

平台获得 = 100 × 5% = 5 街币
开发者获得 = 100 - 5 = 95 街币
```

**修改方法**：编辑 `.env` 文件，修改 `COMMISSION_RATE` 的值

---

## 交易流程

### 流程 1：用户充值街币

```
用户 ──[支付宝支付 100元]──> 支付宝 ──[异步回调]──> 后端
                                           ↓
                                    验证签名和金额
                                           ↓
                                    增加用户街币余额
                                    (根据 CURRENCY_RATE 转换)
                                           ↓
                                      创建 DEPOSIT 交易记录
```

**步骤**：

1. 用户在 APP 选择充值金额（例如 100 元）
2. 后端生成支付参数，返回给 APP
3. APP 调起支付宝 SDK，用户确认支付
4. 支付宝异步回调后端 `/payment/alipay/notify`
5. 后端验证签名，确认支付成功
6. 更新用户钱包：可用余额 += 100 / CURRENCY_RATE

**对应代码**：`WalletService.initiateDeposit()` 和 `.confirmDeposit()`

---

### 流程 2：雇主发布订单

```
雇主
 ↓
[输入订单标题、描述、预算：100 街币]
 ↓
后端验证
 - 检查可用余额 >= 预算？
 - 是：继续；否：返回错误 "余额不足"
 ↓
冻结街币
 - 可用余额 -= 100
 - 冻结余额 += 100
 ↓
创建 ESCROW 交易记录
 ↓
订单状态 = OPEN（等待开发者接单）
```

**修改方法**：检查后端 `OrdersService.createOrder()` 中的余额验证逻辑

---

### 流程 3：订单完成后支付

```
开发者完成订单
        ↓
雇主确认完成
        ↓
后端处理支付
 ↓
计算平台抽佣
 - 开发者应得 = 100 × (1 - 5%) = 95 街币
 - 平台获得 = 100 × 5% = 5 街币
 ↓
更新钱包
 - 雇主：冻结余额 -= 100
 - 开发者：可用余额 += 95
 - 平台账户：可用余额 += 5（可选，内部记账）
 ↓
创建交易记录
 - 雇主：RELEASE 交易
 - 开发者：RELEASE 交易
```

**对应代码**：`OrdersService.completeOrder()`

---

### 流程 4：用户提现街币

```
用户
 ↓
[输入提现街币数、银行账户信息]
 ↓
后端验证
 - 可用余额 >= 提现数？
 - 在 MIN_WITHDRAW_AMOUNT 和 MAX_WITHDRAW_AMOUNT 范围内？
 - 是：继续；否：返回错误
 ↓
创建提现申请（状态=待审核）
 ↓
管理员审核
 - 批准 → 状态=已批准
 - 拒绝 → 状态=被拒绝
 ↓
[如果批准] 执行支付宝转账
 - 调用支付宝转账 API
 - 街币 → 人民币（使用 CURRENCY_RATE 转换）
 - 扣减用户可用余额
 ↓
创建 WITHDRAW 交易记录
```

**对应代码**：
- `WalletService.initiateWithdraw()` - 发起提现
- `WalletService.approveWithdrawal()` - 批准提现
- `WalletService.completeWithdrawal()` - 完成转账

---

## 环境变量配置

### 必须配置的项

在 `.env` 文件中配置以下变量：

```env
# 街币汇率：1 街币 = ? 元人民币
# 【修改】根据业务调整，如 1.0, 0.5, 2.0 等
CURRENCY_RATE=1.0

# 平台抽佣比例（%）
# 【修改】根据商业模式调整，如 5, 10, 15 等
COMMISSION_RATE=5

# 充值限额（街币）
MIN_DEPOSIT_AMOUNT=10
MAX_DEPOSIT_AMOUNT=1000000

# 提现限额（街币）
MIN_WITHDRAW_AMOUNT=100
MAX_WITHDRAW_AMOUNT=50000

# 支付宝配置（用于充值和提现）
ALIPAY_APP_ID=your-app-id
ALIPAY_PRIVATE_KEY=your-private-key
ALIPAY_PUBLIC_KEY=your-public-key
ALIPAY_GATEWAY_URL=https://openapi.alipaydev.com/gateway.do
```

---

## 代码示例

### 计算订单完成后的支付

```typescript
import { JiezbiConfig } from '@/common/constants/jiezbi.constants';

// 订单金额：100 街币
const orderAmount = 100;

// 计算平台抽佣
const commission = JiezbiConfig.calculateCommission(orderAmount);
// 结果：5 街币（假设 COMMISSION_RATE=5）

// 计算开发者应得
const developerReward = JiezbiConfig.calculateDeveloperReward(orderAmount);
// 结果：95 街币

// 将街币转换为人民币
const cnyAmount = JiezbiConfig.convertToCNY(developerReward);
// 结果：95 元（假设 CURRENCY_RATE=1.0）
```

### 查询用户钱包

```typescript
const wallet = await walletService.getWallet(userId);

console.log(`
  用户 ID: ${userId}
  可用余额: ${wallet.balance} 街币
  冻结余额: ${wallet.frozenBalance} 街币
  总资产: ${wallet.balance + wallet.frozenBalance} 街币
  累计充值: ${wallet.totalDeposit} 街币
  累计提现: ${wallet.totalWithdraw} 街币
`);
```

---

## 交易记录类型

| 类型 | 说明 | 何时发生 |
|------|------|----------|
| DEPOSIT | 充值街币 | 用户支付宝支付成功后 |
| WITHDRAW | 提现街币 | 用户提现申请被批准并完成转账后 |
| ESCROW | 冻结街币 | 雇主发布订单时 |
| RELEASE | 释放街币 | 订单完成时，冻结街币转给开发者 |
| REFUND | 退款街币 | 订单被取消时，冻结街币返还给雇主 |
| PENALTY | 罚款 | 用户违规扣款 |
| BONUS | 奖励 | 平台奖励街币 |

---

## 常见问题

### Q1：为什么我的订单冻结了这么多街币？

**A**：当你发布订单时，订单的预算金额会从"可用余额"转移到"冻结余额"。这是为了确保开发者完成工作后能获得报酬。当订单完成或取消时，这笔街币会被释放或退还。

### Q2：完成订单为什么没有收到全部街币？

**A**：因为平台进行了抽佣。例如，订单 100 街币，平台抽 5%，你将获得 95 街币。抽佣比例由管理员在 `COMMISSION_RATE` 配置。

### Q3：可以修改街币汇率吗？

**A**：可以。编辑 `.env` 文件中的 `CURRENCY_RATE`：
- 修改后生效需要重启后端服务
- 只影响新的充值和提现，不影响已完成的交易

### Q4：我提现失败了怎么办？

**A**：
1. 检查可用余额是否足够（冻结余额无法提现）
2. 确认银行账户信息正确
3. 查看提现申请状态
4. 如仍无法解决，联系平台客服

### Q5：平台抽佣的街币去哪里了？

**A**：这部分街币进入平台账户，用于平台运营和维护。具体如何使用由平台决定。

---

## 对账要点

为了确保财务准确，需要进行定期对账：

1. **充值对账**：
   - 每日核对支付宝交易清单和系统记录
   - 确保所有 SUCCESS 状态的 DEPOSIT 交易都正确增加了用户余额

2. **提现对账**：
   - 每周核对支付宝转账清单和系统记录
   - 确保所有 SUCCESS 状态的 WITHDRAW 交易都正确扣减了用户余额

3. **订单对账**：
   - 月度检查所有 COMPLETED 订单的支付转账
   - 验证平台抽佣是否正确计算

---

## 技术细节

### 小数点精度

所有街币金额存储为 `Decimal(12, 2)`，即最多 12 位数字，2 位小数。

### 幂等性

某些操作需要确保幂等性（多次调用结果相同）：

- **确认充值**：如果重复调用，第二次会检查交易状态，如已是 SUCCESS 则直接返回
- **完成转账**：类似处理

### 事务处理

涉及多个表的操作（如完成订单）应使用数据库事务，确保数据一致性。

---

## 下一步

- 实现支付宝 SDK 集成
- 配置银行账户绑定功能
- 建立自动对账流程
- 添加街币转账功能（用户互相转账）

